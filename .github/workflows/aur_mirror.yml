name: AUR Mirror (Sharded PR)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "23 3 * * *"   # daily @ 03:23 UTC

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: aurchy-sync
  cancel-in-progress: false

env:
  AUR_MIRROR: https://github.com/archlinux/aur.git

jobs:
  shard:
    name: Fetch shard (${{ matrix.shard }})
    runs-on: ubuntu-latest
    timeout-minutes: 90
    strategy:
      fail-fast: false
      max-parallel: 24
      matrix:
        shard: [0,1,2,3,4,5,6,7,8,9,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,"_","-"]
    steps:
      - name: Prepare sparse clone for this shard
        shell: bash
        run: |
          set -euo pipefail
          git init aur
          cd aur
          git remote add origin "${AUR_MIRROR}"

          # Discover remote default branch robustly (main vs master)
          git remote set-head origin -a
          DEFAULT_BRANCH="$(git symbolic-ref --short refs/remotes/origin/HEAD | sed 's#^origin/##')"
          echo "Default branch: ${DEFAULT_BRANCH}"

          # Partial clone: tree-only, no blobs; then sparse-checkout the prefix
          git fetch --depth=1 --filter=blob:none origin "${DEFAULT_BRANCH}"
          git sparse-checkout init --no-cone
          git sparse-checkout set "${{ matrix.shard }}*/"
          git checkout FETCH_HEAD
          cd ..
          tar -cf shard-${{ matrix.shard }}.tar aur

      - name: Upload shard artifact
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ matrix.shard }}
          path: shard-${{ matrix.shard }}.tar
          retention-days: 3

  assemble:
    name: Assemble & PR
    needs: shard
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all shard artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: shard-*
          path: shards
          merge-multiple: false

      - name: Merge shards into aur/
        shell: bash
        run: |
          set -euo pipefail
          rm -rf aur
          mkdir -p aur
          find shards -name 'shard-*.tar' -print0 | while IFS= read -r -d '' t; do
            rm -rf _shard && mkdir _shard
            tar -xf "$t" -C _shard
            rsync -a _shard/aur/ aur/
            rm -rf _shard
          done
          # Normalize perms for stable diffs
          find aur -type d -print0 | xargs -0 chmod 755
          find aur -type f -print0 | xargs -0 chmod 644

      - name: Configure git author
        run: |
          git config user.name  "aurchy-bot"
          git config user.email "bot@omarchy.org"

      - name: Commit if changed
        id: commit
        shell: bash
        run: |
          git add aur
          if git diff --cached --quiet; then
            echo "changed=0" >> $GITHUB_OUTPUT
            echo "No changes detected."
          else
            SNAPSHOT_TS="$(date -u +'%Y-%m-%d %H:%M UTC')"
            git commit -m "AUR mirror snapshot: ${SNAPSHOT_TS}"
            echo "changed=1" >> $GITHUB_OUTPUT
          fi

      - name: Create/Update PR
        if: steps.commit.outputs.changed == '1'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "AUR mirror update ($(date -u +'%Y-%m-%d %H:%M UTC'))"
          body: |
            Sharded AUR snapshot into `aur/`.

            Source: ${{ env.AUR_MIRROR }}
            Notes:
            - Partial clone + sparse-checkout (tree-only) per prefix.
            - Remote default branch auto-detected.
          branch: "sync/aur-$(date -u +'%Y%m%d-%H%M')"
          labels: "aur, sync, automated"
          draft: true
          signoff: true
          add-paths: |
            aur/**
          token: ${{ secrets.GITHUB_TOKEN }}
